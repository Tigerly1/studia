{"cells":[{"cell_type":"markdown","metadata":{"id":"PzvFXKTPuTVj"},"source":["# Przetwarzanie wst�pne. Filtracja kontekstowa.\n","\n","\n","### Cel:\n","- zapoznanie z poj�ciem kontekstu / filtracji kontekstowej,\n","- zapoznanie z poj�ciem konwolucji (splotu),\n","- zapoznanie z wybranymi filtrami:\n","\t- filtry liniowe dolnoprzepustowe:\n","\t\t- filtr u�redniaj�cy,\n","\t\t- filtr Gaussa.\n","\t- filtry nielinowe:\n","\t\t- mediana,\n","\t\t- mediana dla obraz�w kolorowych.\n","\t- filtry liniowe g�rnoprzepustowe:\n","\t\t\t- laplasjan,\n","\t\t\t- operator Robersta, Prewitta, Sobela.\n","- zadanie domowe: adaptacyjna filtracja medianowa.\n","\n","### Filtry liniowe u�redniaj�ce (dolnoprzepustowe)\n","\n","Jest to podstawowa rodzina filtr�w stosowana w cyfrowym przetwarzaniu obraz�w. \n","Wykorzystuje si� je w celu \"rozmazania\" obrazu i tym samym redukcji szum�w (zak��ce�) na obrazie.\n","Filtr okre�lony jest przez dwa parametry: rozmiar maski (ang. _kernel_) oraz warto�ci wsp�czynnik�w maski.\n","\n","Warto zwr�ci� uwag�, �e omawiane w niniejszym rozdziale operacje generuj� now� warto�� piksela na podstawie pewnego fragmentu obrazu (tj. kontekstu), a nie jak operacje punktowe tylko na podstawie jednego piksela.\n","\n","\n","1. Wczytaj obraz _plansza.png_.\n","W dalszej cz�ci �wiczenia sprawdzenie dzia�ania filtracji dla innych obraz�w sprowadzi si� do wczytania innego pliku.\n","\n","2. Podstawowa funkcja to `cv2.filter2D`  - realizacja filtracji konwolucyjnej.\n","   Prosz� sprawdzi� jej dokumentacj� i zwr�ci� uwag� na obs�ug� problemu brzegowego (na kraw�dziach istniej� piksele dla kt�rych nie da si� wyznaczy� otoczenia).\n","\n","  Uwaga. Problem ten mo�na te� rozwi�za� z u�yciem funkcji `signal.convolve2d` z biblioteki _scipy_ (`from scipy import signal`).\n","\n","3. Stw�rz podstawowy filtr u�redniaj�cy o rozmiarze $3 \\times 3$ -- za pomoc� funkcji `np.ones`. Wykonaj konwolucj� na wczytanym obrazie. Na wsp�lnym rysunku wy�wietl obraz oryginalny, po filtracji oraz modu� z r�nicy.\n","\n","4. Przeanalizuj otrzymane wyniki. Jakie elementy zawiera obraz \"modu� z r�nicy\"? Co na tej podstawie mo�na powiedzie� o filtracji dolnoprzepustowej?"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"S4Cq3WvAuTVm"},"outputs":[],"source":["import cv2\n","import os\n","import requests\n","from matplotlib import pyplot as plt\n","import numpy as np\n","from scipy import signal\n","\n","url = 'https://raw.githubusercontent.com/vision-agh/poc_sw/master/06_Context/'\n","\n","fileNames = [\"jet.png\", \"kw.png\", \"moon.png\", \"lenaSzum.png\", \"lena.png\", \"plansza.png\"]\n","for fileName in fileNames:\n","  if not os.path.exists(fileName):\n","      r = requests.get(url + fileName, allow_redirects=True)\n","      open(fileName, 'wb').write(r.content)\n","\n"]},{"cell_type":"markdown","metadata":{"id":"10zj2sOTuTVo"},"source":["5. Na wsp�lnym rysunku wy�wietl wyniki filtracji u�redniaj�cej z oknem o rozmiarze 3, 5, 9, 15 i 35. \n","Wykorzystaj polecenie `plt.subplot`. \n","Przeanalizuj wp�yw rozmiaru maski na wynik. "]},{"cell_type":"code","execution_count":null,"metadata":{"id":"Cmf-hkCruTVo"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"zHlUB4tZuTVo"},"source":["6. Wczytaj obraz _lena.png_.\n","Zaobserwuj efekty filtracji dolnoprzepustowej dla obrazu rzeczywistego."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"Ed9hL_iWuTVp"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"t-2FnMuvuTVp"},"source":["7. Niekorzystny efekt towarzysz�cy wykonanym filtracjom dolnoprzepustowym to utrata ostro�ci. \n","Cz�ciowo mo�na go zniwelowa� poprzez odpowiedni dob�r maski. \n","Wykorzystaj mask�:  `M = np.array([1 2 1; 2 4 2; 1 2 1])`. \n","Przed obliczeniami nale�y jeszcze wykona� normalizacj� - podzieli� ka�dy element maski przez sum� wszystkich element�w: `M = M/sum(sum(M));`.\n","Tak przygotowan� mask� wykorzystaj w konwolucji - wy�wietl wyniki tak jak wcze�niej.\n","Mo�liwe jest te� wykorzystywanie innych masek - wsp�czynniki mo�na dopasowywa� do konkretnego problemu."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"9-wJsEWcuTVp"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"ybfc6TZCuTVq"},"source":["8. Skuteczn� i cz�sto wykorzystywan� mask� jest tzw. maska Gasussa.\n","Jest to zbi�r liczb, kt�re aproksymuj� dwuwymiarowy rozk�ad Gaussa. \n","Parametrem jest odchylenie standardowe i rozmiar maski.\n","\n","9. Wykorzystuj�c przygotowan� funkcj� `fgaussian` stw�rz mask� o rozmiarze $5 \\times 5$ i odchyleniu standardowym 0.5.\n","  Wykorzystuj�c funkcj� `mesh` zwizualizuj filtr.\n","  Sprawd� jak parametr ``odchylenie standardowe'' wp�ywa na ``kszta�t'' filtru.\n","\n","  Uwaga. W OpenCV dost�pna jest *dedykowana* funkcja do filtracji Gaussa - `GaussianBlur`.\n","  Prosz� na jednym przyk�adzie por�wna� jej dzia�anie z u�ytym wy�ej rozwi�zaniem.\n","\n","10. Wykonaj filtracj� dla wybranych (2--3) warto�ci odchylenia standardowego.\n"]},{"cell_type":"code","execution_count":null,"metadata":{"scrolled":true,"id":"ZUTDX8IluTVq"},"outputs":[],"source":["def fgaussian(size, sigma):\n","     m = n = size\n","     h, k = m//2, n//2\n","     x, y = np.mgrid[-h:h+1, -k:k+1]\n","     g = np.exp(-(x**2 + y**2)/(2*sigma**2))\n","     return g /g.sum() \n","    \n","    \n","def mesh(fun, size):\n","    fig = plt.figure()\n","    ax = fig.gca(projection='3d')\n","    \n","\n","    X = np.arange(-size//2, size//2, 1)\n","    Y = np.arange(-size//2, size//2, 1)\n","    X, Y = np.meshgrid(X, Y)\n","    Z = fun\n","    \n","    ax.plot_surface(X, Y, Z)\n","    \n","    plt.show()\n","    \n","\n"]},{"cell_type":"markdown","metadata":{"id":"bkN2AOHruTVr"},"source":["### Filtry nieliniowe -- mediana\n","\n","Filtry rozmywaj�ce redukuj� szum, ale niekorzystnie wp�ywaj� na ostro�� obrazu.\n","Dlatego cz�sto wykorzystuje si� filtry nieliniowe - np. filtr medianowy (dla przypomnienia: mediana - �rodkowa warto�� w posortowanym ci�gu liczb).\n","\n","Podstawowa r�nica pomi�dzy filtrami liniowymi, a nieliniowymi polega na tym, �e przy filtracji liniowej na now� warto�� piksela ma wp�yw warto�� wszystkich pikseli z otoczenia (np. u�rednianie, czasem wa�one), natomiast w przypadku filtracji nieliniowej jako nowy piksel wybierana jest kt�ra� z warto�ci otoczenia - wed�ug jakiego� wska�nika (warto�� najwi�ksza, najmniejsza czy w�a�nie mediana).\n","\n","\n","1. Wczytaj obraz _lenaSzum.png_ (losowe 10% pikseli bia�ych lub czarnych - tzw. zak��cenia impulsowe). Przeprowad� filtracj� u�redniaj�c� z rozmiarem maski 3x3. Wy�wietl, podobnie jak wcze�niej, orygina�, wynik filtracji i modu� z r�nicy. Wykorzystuj�c funkcj� ``cv2.medianBlur` wykonaj filtracj� medianow� _lenaSzum.png_ (z rozmiarem maski $3 \\times 3$). Wy�wietl, podobnie jak wcze�niej, orygina�, wynik filtracji i modu� z r�nicy. Kt�ra filtracja lepiej radzi sobie z tego typu szumem?\n","\n","  Uwaga. Taki sam efekt da r�wnie� u�ycie funkcji `signal.medfilt2d`.\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"_ICkvyp3uTVr"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"iSdorMgxuTVr"},"source":["2. Przeprowad� filtracj� u�redniaj�c�, a nast�pnie medianow� obrazu _lena.png_.\n","   Wyniki por�wnaj - dla obu wy�wietl: orygina�, wynik filtracji i modu� z r�nicy.\n","   Szczeg�ln� uwag� zwr�� na ostro�� i kraw�dzie.\n","   W kt�rej filtracji kraw�dzie zostaj� lepiej zachowane?"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"_g2nnTPruTVs"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"OOMWoBCJuTVs"},"source":["3. Ciekawy efekt mo�na uzyska� wykonuj�c filtracj� medianow� wielokrotnie. Okre�la si� go mianem  posteryzacji.  W wyniku przetwarzania z obrazka usuni�te zostaj� detale, a du�e obszary uzyskuj� t� sam� warto�� jasno�ci.  Wykonaj operacj� mediany $5 \\times 5$ na obrazie _lena.png_ 10-krotnie. (wykorzystaj np. p�tl� `for`).\n","\n","\n","Inne filtry nieliniowe:\n","- filtr modowy - moda (dominanta) zamiast mediany,\n","- filtr olimpijski - �rednia z podzbioru otoczenia (bez warto�ci ekstremalnych),\n","- hybrydowy filtr medianowy - mediana obliczana osobno w r�nych podzbiorach otoczenia (np. kszta�t ``x'',``+''), a jako wynik brana jest mediana ze zbioru warto�� elementu centralnego, mediana z ``x'' i mediana z ``+'',\n","- filtr minimalny i maksymalny (b�d� om�wione przy okazji operacji morfologicznych w dalszej cz�ci kursu).\n","\n","\n","Warto zdawa� sobie spraw�, z szerokich mo�liwo�ci dopasowywania rodzaju filtracji do konkretnego rozwa�anego problemu i rodzaju zaszumienia wyst�puj�cego na obrazie."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"KSFMyFBluTVt"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"qPKUMojBuTVt"},"source":["## Filtry liniowe g�rnoprzepustowe (wyostrzaj�ce, wykrywaj�ce kraw�dzie)\n","\n","Zadaniem filtr�w g�rnoprzepustowych jest wydobywanie z obrazu sk�adnik�w odpowiedzialnych za szybkie zmiany jasno�ci - kontur�w, kraw�dzi, drobnych element�w tekstury.\n","\n","### Laplasjan (wykorzystanie drugiej pochodnej obrazu)\n","\n","1. Wczytaj obraz _moon.png_.\n","\n","2. Wprowad� podstawow� mask� laplasjanu:\n","\\begin{equation}\n","M = \n","\\begin{bmatrix}\n","0 & 1& 0 \\\\ 1 & -4 & 1 \\\\ 0 & 1 & 0\n","\\end{bmatrix}\n","\\end{equation}\n","\n","3. Przed rozpocz�ciem oblicze� nale�y dokona� normalizacji maski - dla rozmiaru $3 \\times 3$ podzieli� ka�dy element przez 9.\n","   Prosz� zwr�ci� uwag�, �e nie mo�na tu zastosowa� takiej samej normalizacji, jak dla filtr�w dolnoprzepustowanych, gdy� skutkowa�by to dzieleniem przez 0.\n","\n","4. Wykonaj konwolucj� obrazu z mask� (`c2.filter2D`). Przed wy�wietleniem, wynikowy obraz nale�y podda� normalizacji (wyst�puj� ujemne warto�ci). Najcz�ciej wykonuje si� jedn� z dw�ch operacji:\n","- skalowanie (np. poprzez dodatnie 128 do ka�dego z pikseli),\n","- modu� (warto�� bezwzgl�dna).\n","\n","Wykonaj obie normalizacje. \n","Na wsp�lnym wykresie wy�wietl obraz oryginalny oraz przefiltrowany po obu normalizacjach. "]},{"cell_type":"code","execution_count":null,"metadata":{"id":"iDE-NzUzuTVt"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"jNAsSrd-uTVu"},"source":["7. Efekt wyostrzenia uzyskuje si� po odj�ciu/dodaniu (zale�y do maski) rezultatu filtracji laplasjanowej i oryginalnego obrazu. Wy�wietl na jednym wykresie: obraz oryginalny, sum� orygina�u i wyniku filtracji oraz r�nic� (bezwzgl�dn�) orygina�u i wyniku filtracji.\n"," Uwaga. Aby unikn�� artefakt�w, nale�y obraz wej�ciowy przekonwertowa� do formatu ze znakiem.\n","\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"q2-IHdLjuTVu"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"s7UEkpUFuTVu"},"source":["### Gradienty (wykorzystanie pierwszej pochodnej obrazu)\n","\n","1. Wczytaj obraz _kw.png_. Stw�rz odpowiednie maski opisane w kolejnych punktach i dokonaj filtracji.\n","2. Wykorzystuj�c gradient Robertsa przeprowad� detekcj� kraw�dzi - poprzez wykonanie konwolucji obrazu z dan� mask�:\n","\\begin{equation}\n","R1 = \\begin{bmatrix} 0 & 0 & 0 \\\\ -1 & 0 & 0 \\\\ 0 & 1 & 0 \\end{bmatrix}   \n","R2 = \\begin{bmatrix} 0 & 0 & 0 \\\\ 0 & 0 & -1 \\\\ 0 & 1 & 0 \\end{bmatrix}\n","\\end{equation}\n","\n","Wykorzystaj stworzony wcze�niej kod (przy laplasjanie) - dwie metody normalizacji oraz spos�b wy�wietlania.\n","\n","3. Analogicznie przeprowad� detekcj� kraw�dzi za pomoc� gradientu Prewitta (pionowy i poziomy)\n","\\begin{equation}\n","P1 = \\begin{bmatrix} -1 & 0 & 1 \\\\ -1 & 0 & 1 \\\\ -1 & 0 & 1 \\end{bmatrix}   \n","P2 = \\begin{bmatrix} -1 & -1 & -1 \\\\ 0 & 0 & 0 \\\\ 1 & 1 & 1 \\end{bmatrix}\n","\\end{equation}\n","\n","4. Podobnie skonstruowany jest gradient Sobela (wyst�puje osiem masek, zaprezentowane s� dwie ``prostopad�e''):\n","\\begin{equation}\n","S1 = \\begin{bmatrix} -1 & 0 & 1 \\\\ -2 & 0 & 2 \\\\ -1 & 0 & 1 \\end{bmatrix}   \n","S2 = \\begin{bmatrix} -1 & -2 & -1 \\\\ 0 & 0 & 0 \\\\ 1 & 2 & 1 \\end{bmatrix}\n","\\end{equation}\n","\n","Przeprowad� detekcj� kraw�dzi za pomoc� gradientu Sobela. "]},{"cell_type":"code","execution_count":null,"metadata":{"scrolled":true,"id":"BhwEYhsZuTVv"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"56RoscNzuTVv"},"source":["5. Na podstawie dw�ch ortogonalnych masek np. Sobela mo�na stworzy� tzw. filtr kombinowany - pierwiastek kwadratowy z sumy kwadrat�w gradient�w:\n","\\begin{equation}\n","OW = \\sqrt{(O * S1)^2 + (O * S2)^2}\n","\\end{equation}\n","gdzie:  $OW$ - obraz wyj�ciowy, $O$ - obraz oryginalny (wej�ciowy), $S1,S2$ - maski Sobela, $*$ - operacja konwolucji.\n","\n","Zaimplementuj filtr kombinowany.\n","\n","Uwaga. Prosz� zwr�ci� uwag� na konieczno�� zmiany formatu danych obrazu wej�ciowego - na typ znakiem\n","\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"pobro8ZkuTVv"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"7dsJBZyluTVw"},"source":["6. Istnieje alternatywna wersja filtra kombinowanego, kt�ra zamiast pierwiastka z sumy kwadrat�w wykorzystuje sum� modu��w (prostsze obliczenia). \n","Zaimplementuj t� wersj�. "]},{"cell_type":"code","execution_count":null,"metadata":{"scrolled":true,"id":"fJMIOBGnuTVw"},"outputs":[],"source":[]},{"cell_type":"markdown","metadata":{"id":"Q-3dRwiiuTVw"},"source":["7. Wczytaj plik _jet.png_ (zamiast _kw.png_).\n","Sprawd� dzia�anie obu wariant�w filtracji kombinowanej."]},{"cell_type":"code","execution_count":null,"metadata":{"pycharm":{"name":"#%%\n"},"id":"TAm2toQRuTVw"},"outputs":[],"source":["\n"]}],"metadata":{"celltoolbar":"Raw Cell Format","kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.7.6"},"colab":{"provenance":[],"collapsed_sections":[]}},"nbformat":4,"nbformat_minor":0}